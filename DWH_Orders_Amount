SELECT  b.store_address_id as store_address_id,
      SUM(b.supply_delayed),
  COUNT(order_code)
FROM (
        SELECT store_address_id,
               city,
               dispatching_time_local,
               order_id,
               order_code,
               round(amount, 4) AS supply_delayed,
               cancellation_strategy,
               order_status
        FROM (
                 SELECT o.store_address_id AS store_address_id,
                        o.dispatching_time_local,
                        o.id              AS order_id,
                        o.code            AS order_code,
                        g.code            AS city,
                        g.country_code,
                        CASE
                            WHEN o.mcd_partner
                                THEN o.purchases_estimated_price
                            WHEN g.country_code = 'KE' AND opc.cancellation_strategy = 'PAY_PRODUCTS'
                                THEN o.purchases_estimated_price
                            WHEN opc.cancellation_strategy = 'PAY_PRODUCTS'
                                THEN CASE
                                /* first check if we have a final cost */
                                         WHEN opc.declared_cost > 0
                                             /* convert minor to major currency units */
                                             THEN opc.declared_cost / power(10, c.digits)
                                /* otherwise consider the estimated */
                                         ELSE o.purchases_estimated_price END
                            ELSE 0 END    AS amount,
                        opc.cancellation_strategy,
                        s.type            AS order_status
                 FROM orders o
                          JOIN statuses s ON o.id = s.order_id
                          JOIN geography g ON g.code = o.city_code
                          JOIN currency c ON o.currency = c.code
                          LEFT JOIN order_partner_compensations opc
                                    ON opc.order_id = o.id -- we also care about mktplace partners
                          LEFT JOIN dispatched_partner_orders dpo ON dpo.order_id = o.id
               WHERE g.country_code = 'ES'
                   AND dpo.dispatching_time_local BETWEEN '2023-07-17 00:00:00' AND '2023-07-23 23:59:59'
                 AND  o.store_address_id IN (178594,161117,164428,190067,190081,190049,165557,163952,164223,164232,165359,161694,161844,152145,152146,165314,161705,161667,161690,161704,156087,154889,156092,191815,165317,165287,161702,161718,156095,156106,156117,156128,156140,164924,165002,165009,165019,165025,164812,164840,164957,164968,164981,164987,164992,165014,165020,161109,163967,161586,161594,156177,164718,156180,158765,165558,156080,234785,165309,165312,161111,165280,165282,165286,165288,178252,165266,165244,165265,164499,165274,165247,165255,165260,164542,164573,164587,164595,158753,164603,164792,164810,164847,164900,165313,165291,182880,165425,165306,165621,165577,165578,173497,158735,158736,165332,164619,189785,158752,234769,165612,165330,164581,234792,161120,161123,165447,165328,150122,165618,152144,162033,164545,165262,185055,165264,165261,164553,165259,165263,164638,150106,164651,152163,165617,158708,165564,178264,163970,164756,163977,162423,161895,161134,161606,165316,156281,336752,158750,161739,173344,162271,162001,164652,164467,156711,161735,165620,152150,336686,176232,165327,161837,161892,161142,163998,164672,164492,164556,173454,156285,161621,161126,283869,161754,161077,158729,176221,161693,336703,161774,158743,156287,158747,158748,189767,156288,190083,165302,152176,173485,158761,158760,161848,161918,173502,164613,176177,535146,161963,313457,161118,178285,165574,164005,234738,178290,164826,394672,164011,165358,547062,152165,150113,156297,165516,161936,176209,181029,234771,185172,178305,165579,161828,161778,191802,158763,152158,161711,161732,161741,173494,156315,161136,178307,158813,178062,173506,178310,161127,176187,161681,173474,257008,611324,161841,156328,234781,161559,173492,156697,164715,161886,176215,161107,161939,173472,161133,178312,173348,456069,181032,156680,162429,180080,162404,165331,605314,170153,161764,206928,164684,165326,556462,173480,176191,425283,175114,161793,165271,156440,187196,234766,161977,165454,161775,161137,160929,161856,158762,178313,178319,161948,331199,165322,176184,161100,158744,161651,152149,158757,163679,150109,150126,161834,321654,144306,493453,172934,158758,165583,165296,173484,156441,161105,234793,152156,156444,156445,178322,178547,611987,165536,176227,165587,162314,150124,176164,152159,178325,165360,164416,152168,165367,161657,256796,152139,326608,161669,161899,185104,161631,199516,173463,178330,454990,178335,161767,173504,161143,187227,164706,178528,162045,176262,178338,161737,248417,176260,161905,161885,187514,183545,158759,161609,161583,178533,178870,190093,181050,164228,165278,161888,162014,173481,181038,164748,162406,161850,161838,162342,185401,158619,156446,157215,157217,158623,178344,176234,336706,180076,186563,178350,161822,182897,175566,171235,186066,186554,185963,198054,165406,199745,199832,195704,179366,174760,184745,180072,180064,144308,180067,181275,185185,185096,185092,182560,182556,182552,181010,219428,191806,216320,185953,196502,187204,195721,184748,186037,185976,184793,198059,198065,185389,190090,163750,223271,215317,215531,223580,215552,195693,178073,587975,329704,204693,202172,195694,220637,424160,158755,204687,208353,215847,215549,215872,215862,215516,161071,219710,223166,223113,223171,223149,220725,249149,164536,249502,223263,223184,244863,556455,229058,239500,260844,305258,611989,239454,238698,238690,238700,249117,239377,238692,589841,253684,249422,267303,253669,303161,302227,249439,239507,249431,152142,372698,267108,273962,327776,274547,273557,273947,277332,165622,165279,275172,445521,275255,283866,164534,296766,298307,329054,301707,163765,313377,336750,306381,306367,319503,156689,363289,337692,338567,314068,173486,407275,371399,327582,346959,447914,362222,362199,369862,369811,369841,369830,369797,366744,362224,369852,440668,447340,163820,372806,372830,388476,388465,499709,410360,499652,406928,396946,372763,406666,161813,405043,179368,440654,164439,440735,447738,352525,447928,164685,406664,161113,404998,404996,419325,426652,434076,429818,445911,438617,436020,161115,438594,439055,435426,497454,497454,480541,448636,440618,440696,165555,448721,474381,566479,466395,464163,556456,178058,163896,537960,493889,494022,185084,504249,537577,549001,537336,161542,165337,520493,537723,537718,566396,198076,549457,537716,562565,566400,165364,581831,596512,589864,566393,607145,566410,566363,601978,609097,595269,607514,607510,594371,607149,585013,585015,178093,165433,589859,590578,590568,596167,596203,598892,605455,601466,165362,611269,614293,165386,164658,165300,165602,185202,178234,259748,234779)
                   AND s.type IN ('DeliveredStatus', 'CanceledStatus')) a) b
GROUP BY 1;
