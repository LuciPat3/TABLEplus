SELECT  b.store_address_id as store_address_id,
      SUM(b.supply_delayed),
  COUNT(order_code)
FROM (
        SELECT store_address_id,
               city,
               dispatching_time_local,
               order_id,
               order_code,
               round(amount, 4) AS supply_delayed,
               cancellation_strategy,
               order_status
        FROM (
                 SELECT o.store_address_id AS store_address_id,
                        o.dispatching_time_local,
                        o.id              AS order_id,
                        o.code            AS order_code,
                        g.code            AS city,
                        g.country_code,
                        CASE
                            WHEN o.mcd_partner
                                THEN o.purchases_estimated_price
                            WHEN g.country_code = 'KE' AND opc.cancellation_strategy = 'PAY_PRODUCTS'
                                THEN o.purchases_estimated_price
                            WHEN opc.cancellation_strategy = 'PAY_PRODUCTS'
                                THEN CASE
                                /* first check if we have a final cost */
                                         WHEN opc.declared_cost > 0
                                             /* convert minor to major currency units */
                                             THEN opc.declared_cost / power(10, c.digits)
                                /* otherwise consider the estimated */
                                         ELSE o.purchases_estimated_price END
                            ELSE 0 END    AS amount,
                        opc.cancellation_strategy,
                        s.type            AS order_status
                 FROM orders o
                          JOIN statuses s ON o.id = s.order_id
                          JOIN geography g ON g.code = o.city_code
                          JOIN currency c ON o.currency = c.code
                          LEFT JOIN order_partner_compensations opc
                                    ON opc.order_id = o.id -- we also care about mktplace partners
                          LEFT JOIN dispatched_partner_orders dpo ON dpo.order_id = o.id
               WHERE g.country_code = 'ES'
                   AND dpo.dispatching_time_local BETWEEN '2024-03-25 00:00:00' AND '2024-03-31 23:59:59'
                 AND  o.store_address_id IN (161918,186771,161139,161948,216320,156287,165255,165288,202172,190121,176227,175098,215862,173502,173500,161850,161885,165266,158708,158729,158735,158736,158743,158744,172934,185416,232694,161737,184861,178334,161822,179366,181038,158746,161143,165359,215872,185202,176599,178347,158750,164467,173472,164826,181032,199745,204693,165358,176177,178305,202189,178522,198065,165322,219428,165558,180064,173474,208353,161841,161735,162423,161586,161594,161621,161631,161669,161681,161693,161702,161718,161739,161754,161778,161793,161929,165244,165247,165260,165265,182897,229058,190093,195721,163970,164756,182552,165564,165574,163896,223184,173429,187227,158747,158813,161583,183545,173484,158752,178594,181010,190081,173348,178285,165406,165425,171217,182560,176191,176215,156680,223171,195704,178234,173497,187514,185963,161831,165617,180063,215549,176163,199832,176209,161134,161136,178350,161837,158765,190090,185055,185084,164505,175114,195716,196061,196063,158763,161844,219710,185092,163998,178290,173355,173481,165555,158748,158758,173480,186066,181050,178342,191802,195689,234738,234766,234769,234779,161888,164217,198076,176164,165300,165316,186554,173486,158753,158762,161724,161767,161775,152176,158623,165357,165367,165433,165557,184793,161892,161899,191760,161905,164223,164228,164232,185389,162271,163679,182556,178252,144306,152142,152144,152145,152146,152149,220637,185868,178073,158761,156689,165328,165331,173463,189785,185096,162342,165337,163750,165269,165271,191806,162406,163977,164658,223149,165326,190067,173344,195661,173504,162033,162045,165261,165264,156697,165374,198059,163988,161727,150106,150109,150113,150122,150124,150126,154889,156080,156087,156092,156095,156106,156117,156121,156128,156140,156177,156180,156181,156276,156279,156281,156285,156288,156297,156306,156315,156320,156328,156331,156440,156441,156442,156444,156445,156446,157215,157217,164345,164499,164534,164542,164573,164587,164595,164603,164619,164638,164651,164672,164684,164706,164748,164792,164810,164812,164840,164847,164900,164924,164957,164968,164981,164987,164992,165002,165009,165014,165019,165020,165025,179934,180072,186037,190115,201520,215516,215847,219074,223263,223271,162014,165280,165282,165286,165291,165306,165309,165312,165313,191815,206928,161845,162001,196502,178322,165386,173494,161977,165612,178326,176232,161963,178330,185104,234744,234771,234781,234785,234792,234793,190098,178528,176187,180076,202286,173436,181056,216727,158755,161071,161077,161100,161105,186563,232600,144308,152139,164456,164492,164536,164556,223580,161606,161651,161838,165447,178338,178335,185976,191828,163967,174760,165270,165278,165279,161828,161834,164416,164428,164439,179368,176184,161939,190054,173454,195694,161886,161895,152163,152165,152168,165259,165583,165618,161936,185953,163820,164613,165516,191692,220725,176234,185185,187235,178312,165274,180067,165360,189739,178310,175566,152150,173492,178545,161813,162404,164685,215531,184748,178062,165364,165362,174995,173460,216789,178325,199516,187196,162429,195693,176262,180080,161609,161657,161667,161678,161690,161694,161704,161705,161711,161732,161741,161764,164360,165287,165302,165314,165317,165536,183167,191888,215317,187204,161559,165296,165577,165578,165579,161856,178307,152154,152155,152156,157114,157117,157120,157123,157135,164533,164545,164553,164581,164676,195709,220717,178520,165622,162314,189767,170153,178547,182880,185401,152153,156711,198054,165263,161118,152158,152159,165620,178292,214521,176221,161931,161933,165318,165321,161855,161137,161142,178058,161133,161127,165615,178264,178870,176260,204687,184847,152151,158619,165262,223166,158757,158759,158760,160929,161109,161111,161113,161115,161117,161120,161123,161126,161128,161542,161774,171235,190083,190125,232700,232702,232704,178093,178282,164005,164718,190049,163765,164634,215552,178313,181029,173485,164353,165327,165330,165332,181275,223113,178327,165602,178319,178344,161107,165454,161848,173506,185172,163952,164011,164652,164715,184745,14976,178533,165587,165621,202151,238690,238692,238698,238700,239377,239454,239500,239507,239518,244247,244271,244863,244865,248417,249117,249149,249410,249422,249431,249439,249502,253669,253684,256796,257008,259433,259748,260844,267108,267113,267303,273557,273947,273962,274547,275172,275255,277332,283866,283869,296766,298307,301707,301713,302227,303161,305258,306367,306381,309666,309722,309870,313377,313457,314068,319503,321654,326608,327582,327653,327687,327776,327800,327819,329054,329704,331199,336686,336703,336706,336744,336750,336752,336753,337692,338567,346959,350055,352498,352525,362199,362222,362224,363289,366744,369797,369811,369830,369841,369852,369862,371399,372698,372720,372735,372746,372763,372773,372783,372806,372830,376676,388465,388476,394672,396946,404996,404998,405043,406465,406664,406666,406928,407275,410360,419325,424160,425283,426652,429818,434076,435426,435440,436020,436143,438577,438594,438617,438625,439055,440618,440654,440668,440696,440735,445521,445911,447340,447738,447785,447914,447928,448585,448636,448721,452919,454340,454990,456069,464163,465773,466395,474381,479829,480541,493453,493889,494022,494698,497454,499652,499709,504249,520493,535146,537336,537577,537716,537718,537723,537960,547062,549001,549457,556455,556456,556462,562565,566363,566393,566396,566400,566410,566479,566489,581831,585013,585015,587975,589841,589859,589864,590568,590578,594371,595269,596167,596192,596203,596435,596512,598892,601466,601948,601978,605314,605455,607145,607149,607510,607514,609097,610880,611269,611324,611987,611989,614293,614941,615961,616007,616011,616015,616018,616354,617185,618507,618531,620010,620339,620340,624752,625026,628861,628879,628931,628938,628963,628965,633176,633187,634804,641176,641257,642262,643117,643154,643174,643176,643183,647959,655849,656333,657935,694006,699405,699416,699425,700187,704790,709255,711305,711368,711379,711381,711398,712912,716864,718011,718024,719360,719549,719696,720219,723834,726323,729587,736207,738605,739175,740323,754962,754974,755094)
                   AND s.type IN ('DeliveredStatus', 'CanceledStatus')) a) b
GROUP BY 1;
